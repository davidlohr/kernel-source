From: Paulo Alcantara <pc@cjr.nz>
Date: Fri, 16 Dec 2022 14:00:19 -0300
Subject: [PATCH] cifs: set correct ipc status after initial tree connect
Git-commit: 86fe0fa8747fb1bc4cc44fc1966e0959fe752f38
References: bsc#1190317
Patch-mainline: v6.2-rc1

cifs_tcon::status wasn't correctly updated to TID_GOOD after
establishing initial IPC connection thus staying at TID_NEW as long as
it wasn't reconnected.

Cc: stable@vger.kernel.org
Signed-off-by: Paulo Alcantara (SUSE) <pc@cjr.nz>
Signed-off-by: Steve French <stfrench@microsoft.com>
Acked-by: Enzo Matsumiya <ematsumiya@suse.de>
---
 fs/cifs/connect.c |    7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@ -3156,6 +3156,9 @@ cifs_setup_ipc(struct cifs_ses *ses, str
 
 	cifs_dbg(FYI, "IPC tcon rc = %d ipc tid = %d\n", rc, tcon->tid);
 
+	spin_lock(&tcon->tc_lock);
+	tcon->tidStatus = CifsGood;
+	spin_unlock(&tcon->tc_lock);
 	ses->tcon_ipc = tcon;
 out:
 	unload_nls(nls_codepage);
@@ -3511,10 +3514,10 @@ cifs_get_smb_ses(struct TCP_Server_Info
 	list_add(&ses->smb_ses_list, &server->smb_ses_list);
 	spin_unlock(&cifs_tcp_ses_lock);
 
-	free_xid(xid);
-
 	cifs_setup_ipc(ses, volume_info);
 
+	free_xid(xid);
+
 	return ses;
 
 get_ses_fail:
